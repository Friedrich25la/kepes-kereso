<!doctype html>
<html lang="hu">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Termékkereső 8.3 — Trinexus (Content & Logic Merged)</title>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,100..1000&family=Jersey+10&family=Asap:wght@400;500;600&display=swap"
    rel="stylesheet">

  <script>window.MIN_TOKEN_LEN = window.MIN_TOKEN_LEN || 3;</script>
  <script>window.API_BASE = 'https://aquamarine-cactus-d0f609.netlify.app/.netlify/functions/search';</script>

  <style>
    /* =========================================
       0. FONTOK
       ========================================= */
    @font-face {
      font-family: 'Gentona';
      src: url('Gentona-Bold.otf') format('opentype'),
        url('Gentona-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
    }

    @font-face {
      font-family: 'Gentona';
      src: url('Gentona-Light.otf') format('opentype'),
        url('Gentona-Light.ttf') format('truetype');
      font-weight: 300;
      font-style: normal;
    }

    /* =========================================
       1. ALAP STÍLUSOK
       ========================================= */
    :root {
      --accent: #33CCBE;
      --bg: #ffffffe9;
      --muted: #666;
      --text-main: #111;
      --card-bg: #fff;
      --card-border: #eee;
      --header-bg: #9b9b9b;

      --thumb: 150px;
      --gap: 12px;
      --overlay-height: 38px;
      --max-width: 1200px;
      --card-width: 180px;
      --sidebar-width: 320px;
      --accent-dark: #28a398;

      --glow-backdrop: hsl(0 0% 60% / 0.12);
      --border: 9;
      --backup-border: var(--glow-backdrop);
      --radius: 12px;
    }

    body:has(.switcher__input[value="dark"]:checked) {
      --bg: #3a3a3a;
      --text-main: #e1e1e1;
      --muted: #aaa;
      --card-bg: #2a2a2c;
      --card-border: #444;
      --header-bg: #2e2d2d;
      --accent: #33CCBE;
      --accent-dark: #28a398;
      --glow-backdrop: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      transition: background 0.4s ease, color 0.4s ease;
    }

    .container {
      max-width: var(--max-width);
      margin: 18px auto;
      padding: 18px;
    }

    /* HEADER */
    .site-header {
      width: 100%;
      background: var(--header-bg);
      position: relative;
      padding: 12px 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      z-index: 100;
      transition: background 0.4s ease;
    }

    .header-wrap {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 5px 56px;
      position: relative;
    }

    .logo-link {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-block;
      z-index: 5;
      text-decoration: none;
    }

    .logo {
      height: 44px;
      width: auto;
      display: block;
    }

    .text {
      font-family: 'Gentona', sans-serif;
      font-size: 2.2vw;
      color: #f8f7f7;
      position: relative;
      z-index: 3;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .brand-main {
      font-weight: 700;
      margin-right: 6px;
    }

    .brand-sub {
      font-weight: 300;
      opacity: 0.9;
    }

    @media (max-width: 480px) {
      .text {
        font-size: 5vw;
        margin: 0 30px;
      }
    }

    /* KERESŐ SÁV */
    .search-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 25px;
      justify-content: center;
    }

    .search-row input.search {
      flex: 1;
      min-width: 320px;
      padding: 12px 14px;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      background: var(--card-bg);
      color: var(--text-main);
    }

    .controls-row {
      display: flex;
      gap: 30px;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      position: relative;
      z-index: 50;
    }

    .controls-row input[type=checkbox] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid var(--card-border);
      background: var(--bg);
    }

    /* DROPDOWN */
    .field.menu {
      font-family: Asap, system-ui, sans-serif;
      position: relative;
      flex: 1;
      min-width: 160px;
      max-width: 260px;
    }

    .field.menu .control {
      position: relative;
    }

    .field.menu button {
      font-size: 14px;
      text-align: start;
      border-radius: var(--radius);
      padding: 8px 14px;
      padding-inline-end: 30px;
      width: 100%;
      transition: all 0.3s cubic-bezier(0.33, 1, 0.68, 1);
      background: var(--card-bg);
      color: var(--text-main);
      border: 1px solid var(--card-border);
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field.menu button::after {
      content: '';
      position: absolute;
      right: 14px;
      top: 50%;
      width: 10px;
      height: 6px;
      background-color: var(--muted);
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      transform: translateY(-50%);
      transition: transform 0.3s;
    }

    .field.menu.open button::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .field.menu button:hover {
      border-color: var(--accent);
    }

    .field.menu menu {
      background: var(--card-bg);
      padding: 6px;
      margin: 0;
      border-radius: calc(var(--radius) * 1.2);
      display: none;
      flex-direction: column;
      gap: 4px;
      position: absolute;
      top: calc(100% + 8px);
      width: 100%;
      min-width: 220px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--card-border);
      z-index: 9999;
      opacity: 0;
      scale: 1 0.9;
      transition: opacity 0.2s, scale 0.2s;
      list-style: none;
      max-height: 400px;
      overflow-y: auto;
    }

    .field.menu.open menu {
      display: flex;
      opacity: 1;
      scale: 1 1;
    }

    .field.menu menu li {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .field.menu menu li svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .field.menu menu li>* {
      margin: 0;
    }

    .field.menu menu li h3 {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .field.menu menu li:hover,
    .field.menu menu li:focus {
      background: rgba(51, 204, 190, 0.1);
    }

    .field.menu menu li.selected {
      background: rgba(51, 204, 190, 0.15);
    }

    /* SLIDER */
    #slider-wrapper {
      display: flex;
      align-items: center;
      gap: 0;
      width: 240px;
      flex: 0 0 240px;
      position: relative;
      height: 40px;
      padding: 0 10px;
      margin-top: 5px;
    }

    #slider {
      flex: 1;
      position: relative;
      --range-slider: #e0e0e0;
      --range-handle: var(--accent);
      --range-handle-inactive: #999;
      --range-handle-focus: var(--accent-dark);
      --range-range: var(--accent);
      --range-pip: var(--muted);
    }

    body:has(.switcher__input[value="dark"]:checked) #slider {
      --range-slider: #444;
    }

    .price-label {
      font-family: "Jersey 10", monospace;
      font-size: 1.1em;
      color: var(--text-main);
      position: absolute;
      top: -14px;
      pointer-events: none;
      transition: transform 0.2s ease, left 0.2s;
      white-space: nowrap;
      font-weight: normal;
      transform: translateX(-50%);
    }

    #price-min {
      translate: calc((var(--slider-length) * (var(--pos) / 100) * 1px)) 0;
    }

    #price-max {
      translate: calc((var(--slider-length) * (var(--pos) / 100) * 1px)) 0;
    }

    .rangeSlider {
      height: 4px !important;
      border-radius: 2px !important;
      margin: 0 !important;
    }

    .rangeHandle {
      transform: none !important;
      border-radius: 50% !important;
      width: 16px !important;
      height: 16px !important;
      top: -6px !important;
      background: var(--accent) !important;
      border: none !important;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .rangeHandle::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: inherit;
      border-radius: 50% 50% 0 50%;
      transform: rotate(-45deg);
      top: 0;
      left: 0;
      z-index: -1;
    }

    .rangeBar {
      height: 4px !important;
      background: var(--accent) !important;
    }

    /* AMAZON GRID STYLES - JAVÍTOTT (LINK KEZELÉS + SORTÖRÉS FIX) */
    .amz-grid-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 30px 0;
      width: 100%;
    }

    .amz-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 20px;
      flex: 1;
      min-width: 260px;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      color: var(--text-main);
      position: relative;
    }

    .amz-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--text-main);
    }

    .amz-grid-inner {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      flex: 1;
      margin-bottom: 15px;
    }

    .amz-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .amz-item a {
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .amz-item img {
      width: 100%;
      aspect-ratio: 1/1;
      object-fit: cover;
      border-radius: 4px;
      background: #f0f0f0;
      transition: transform 0.2s;
      cursor: pointer;
    }

    .amz-item a:hover img {
      transform: scale(1.05);
    }

    .amz-item span {
      font-size: 12px;
      color: var(--muted);
      /* JAVÍTÁS: Sortörés engedélyezése */
      white-space: normal;
      line-height: 1.3;
      text-align: center;
      display: block;
      margin-top: 4px;
      transition: color 0.2s;
      cursor: pointer;
    }

    .amz-item a:hover+span,
    .amz-item span:hover {
      color: var(--accent);
    }

    a.amz-footer {
      font-size: 13px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      margin-top: auto;
      display: inline-block;
    }

    a.amz-footer:hover {
      text-decoration: underline;
      color: var(--accent-dark);
    }


    /* RESULTS */
    .results-meta {
      text-align: right;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
      margin-right: 8px;
      font-weight: 500;
    }

    .results {
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      min-height: 120px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-start;
    }

    /* CARD STYLES */
    .card {
      width: var(--card-width);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      overflow: visible;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: transform .14s ease, box-shadow .14s ease;
      position: relative;
      isolation: isolate;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.12);
      z-index: 10;
    }

    [data-glow] {
      --border-size: calc(var(--border, 2) * 1px);
      --spotlight-size: calc(var(--size, 150) * 1px);
      --hue: calc(var(--base, 190) + (var(--xp, 0) * var(--spread, 0)));
      background-image: radial-gradient(var(--spotlight-size) var(--spotlight-size) at calc(var(--x, 0) * 1px) calc(var(--y, 0) * 1px),
          hsl(var(--hue, 210) calc(var(--saturation, 100) * 1%) calc(var(--lightness, 70) * 1%) / var(--bg-spot-opacity, 0.1)), transparent);
      background-color: var(--glow-backdrop, transparent);
      background-size: calc(100% + (2 * var(--border-size))) calc(100% + (2 * var(--border-size)));
      background-position: 50% 50%;
      background-attachment: fixed;
      border: var(--border-size) solid var(--backup-border);
      position: relative;
      touch-action: none;
      border-radius: 12px;
      z-index: 1;
    }

    [data-glow]::before,
    [data-glow]::after {
      pointer-events: none;
      content: "";
      position: absolute;
      inset: calc(var(--border-size) * -1);
      border: var(--border-size) solid transparent;

      border-radius: calc(12px + var(--border-size));

      background-attachment: fixed;
      background-size: calc(100% + (2 * var(--border-size))) calc(100% + (2 * var(--border-size)));
      background-repeat: no-repeat;
      background-position: 50% 50%;
      mask: linear-gradient(transparent, transparent), linear-gradient(white, white);
      mask-clip: padding-box, border-box;
      mask-composite: intersect;
    }

    [data-glow]::before {
      background-image: radial-gradient(calc(var(--spotlight-size) * 0.75) calc(var(--spotlight-size) * 0.75) at calc(var(--x, 0) * 1px) calc(var(--y, 0) * 1px),
          hsl(var(--hue, 210) calc(var(--saturation, 100) * 1%) calc(var(--lightness, 50) * 1%) / var(--border-spot-opacity, 1)), transparent 100%);
      filter: brightness(2);
      z-index: 0;
    }

    [data-glow]::after {
      background-image: radial-gradient(calc(var(--spotlight-size) * 0.5) calc(var(--spotlight-size) * 0.5) at calc(var(--x, 0) * 1px) calc(var(--y, 0) * 1px),
          hsl(var(--hue, 210) calc(var(--saturation, 100) * 1%) calc(92 * 1%) / var(--border-light-opacity, 0.85)), transparent 100%);
    }

    .card-bg {
      position: absolute;
      inset: 0;
      background: var(--card-bg);
      border-radius: 12px;
      z-index: 0;
    }

    .card img {
      width: 100%;
      height: var(--thumb);
      object-fit: cover;
      display: block;
      background: #f6f6f6;
      border-radius: 12px 12px 0 0;
    }

    .card>.overlay,
    .card>.meta {
      position: relative;
      z-index: 2;
    }

    .overlay {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .name-bar {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: var(--overlay-height);
      display: flex;
      align-items: center;
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.45);
      color: #fff;
      font-size: 12px;
      backdrop-filter: blur(2px);
    }

    .meta {
      padding: 8px 10px;
      border-top: 1px solid #f4f4f4;
      font-size: 13px;
      background: var(--card-bg);
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border-radius: 0 0 12px 12px;
    }

    .meta .price {
      font-weight: 700;
    }

    /* UI ELEMENTS */
    .fav-icon {
      position: absolute;
      top: 8px;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
      z-index: 20;
      right: 8px;
      color: #ccc;
    }

    .fav-icon:hover {
      transform: scale(1.15);
      background: #fff;
    }

    .fav-icon.active {
      color: #FFD700;
    }

    .fav-icon svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* FANCY GOMB */
    .fancy-btn-container {
      display: flex;
      justify-content: center;
      padding: 40px 0;
      width: 100%;
    }

    .fancy-btn {
      --size: 18px;
      font-size: var(--size);
      font-family: inherit;
      appearance: none;
      background: transparent;
      padding: 1em 2em;
      border-radius: 100px;
      border: 1px solid #ccc;
      color: var(--text-main);
      position: relative;
      overflow: hidden;
      transition: color .40s ease;
      cursor: pointer;
      font-weight: 600;
      z-index: 1;
    }

    .fancy-btn:hover {
      color: #000;
      border-color: #333;
    }

    .fancy-btn .btn-content {
      pointer-events: none;
      position: relative;
      z-index: 3;
    }

    .fancy-btn .btn-cells {
      position: absolute;
      z-index: 2;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-auto-rows: 1fr;
      overflow: hidden;
    }

    .fancy-btn .btn-cells span {
      width: 100%;
      height: 100%;
      display: block;
      position: relative;
    }

    .fancy-btn .btn-cells span:before {
      content: "";
      display: block;
      position: absolute;
      width: 50px;
      height: 50px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: var(--accent);
      background-image: linear-gradient(to right, var(--accent), #fff);
      transition: transform .4s ease;
      border-radius: 100px;
      opacity: 0.8;
    }

    .fancy-btn .btn-cells span:hover:before {
      transform: translate(-50%, -50%) scale(12);
    }

    /* SIDEBAR */
    #fav-sidebar {
      position: fixed;
      top: 0;
      right: -320px;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--card-bg);
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      display: flex;
      flex-direction: column;
      color: var(--text-main);
    }

    #fav-sidebar.open {
      right: 0;
    }

    .sidebar-tabs {
      display: flex;
      background: var(--bg);
      border-bottom: 1px solid var(--card-border);
    }

    .sidebar-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .sidebar-tab.active {
      color: var(--text-main);
      border-bottom-color: var(--accent);
      background: var(--card-bg);
    }

    .close-sidebar-abs {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      background: none;
      border: none;
    }

    .sidebar-content-wrapper {
      flex: 1;
      overflow-y: auto;
      position: relative;
    }

    .sidebar-pane {
      display: none;
      padding: 10px;
      flex-direction: column;
      gap: 10px;
    }

    .sidebar-pane.active {
      display: flex;
    }

    /* History Styles */
    .history-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin: 15px 0 5px;
      font-weight: bold;
      border-bottom: 1px solid var(--card-border);
      padding-bottom: 4px;
    }

    .history-tag {
      display: inline-block;
      padding: 4px 10px;
      background: var(--bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      font-size: 13px;
      margin: 0 5px 5px 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-tag:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .fav-item {
      display: flex;
      gap: 10px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      padding: 8px;
      border-radius: 4px;
      align-items: center;
      position: relative;
      transition: transform 0.2s;
    }

    .fav-item:hover {
      transform: translateX(-2px);
      border-color: var(--accent);
    }

    .fav-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 3px;
      cursor: pointer;
      border: 1px solid #eee;
    }

    .fav-info {
      flex: 1;
      overflow: hidden;
    }

    .fav-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }

    .fav-price {
      font-size: 12px;
      color: var(--muted);
      font-weight: bold;
    }

    .remove-fav {
      color: #999;
      cursor: pointer;
      padding: 4px;
      font-size: 18px;
      line-height: 1;
    }

    .remove-fav:hover {
      color: #ff4444;
    }

    .sidebar-footer {
      padding: 15px;
      border-top: 1px solid var(--card-border);
      background: var(--bg);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      font-weight: 600;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .sidebar-btn:hover {
      background: var(--accent-dark);
    }

    .clear-btn {
      background: transparent;
      color: #d9534f;
      border: 1px solid #d9534f;
      font-size: 12px;
      padding: 8px;
    }

    .clear-btn:hover {
      background: #d9534f;
      color: #fff;
    }

    /* LEBEGŐ GOMB (KEDVENCEK) */
    #fav-trigger {
      position: fixed;
      top: 130px;
      right: 0;
      background: var(--accent);
      color: #fff;
      padding: 10px 15px 10px 12px;
      border-radius: 20px 0 0 20px;
      box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 900;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: right 0.3s;

      width: auto;
      min-width: 140px;
      justify-content: flex-start;
    }

    #fav-trigger:hover {
      padding-right: 20px;
    }

    body.sidebar-open #fav-trigger {
      right: -100px;
    }

    #fav-count {
      background: #fff;
      color: var(--accent);
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
      margin-left: auto;
    }

    /* KATEGÓRIA GOMB */
    #cat-trigger {
      position: fixed;
      top: 185px;
      right: 0;
      background: #777;
      color: #fff;
      padding: 10px 15px 10px 12px;
      border-radius: 20px 0 0 20px;
      box-shadow: -2px 2px 5px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 899;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      transition: right 0.3s;

      width: auto;
      min-width: 140px;
      justify-content: flex-start;
    }

    #cat-trigger:hover {
      padding-right: 20px;
    }

    body.sidebar-open #cat-trigger {
      right: -100px;
    }

    .mobile-star {
      display: none;
    }

    /* SWITCHER */
    .switcher {
      position: absolute;
      right: -140px;
      top: 50%;
      transform: translateY(-50%) scale(0.35);
      transform-origin: right center;
      z-index: 20;
      display: flex;
      align-items: center;
      gap: 8px;
      width: 154px;
      height: 70px;
      box-sizing: border-box;
      padding: 8px 12px 10px;
      border: none;
      border-radius: 99em;
      background-color: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .switcher__legend,
    .switcher__input,
    .switcher__filter {
      position: absolute;
      width: 0;
      height: 0;
      overflow: hidden;
      opacity: 0;
    }

    .switcher__option {
      --c: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 16px;
      width: 68px;
      height: 100%;
      box-sizing: border-box;
      border-radius: 99em;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .switcher__option:hover .switcher__icon {
      transform: scale(1.2);
    }

    .switcher__icon {
      width: 24px;
      height: 24px;
      fill: var(--text-main);
      transition: transform 0.2s;
    }

    .switcher::after {
      content: '';
      position: absolute;
      left: 4px;
      top: 4px;
      display: block;
      width: 68px;
      height: calc(100% - 10px);
      border-radius: 99em;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 1;
      transition: transform 0.4s cubic-bezier(1, 0.0, 0.4, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .switcher:has(input[value="light"]:checked)::after {
      transform: translateX(0);
    }

    .switcher:has(input[value="dark"]:checked)::after {
      transform: translateX(76px);
    }

    /* ANIMÁCIÓ */
    .flying-img {
      position: fixed;
      z-index: 9999;
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 50%;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      top: 0;
      left: 0;
    }

    .fly-container {
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      pointer-events: none;
      transition: transform 0.8s ease-in;
    }

    .fly-inner {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      background: #fff;
      border: 2px solid var(--accent);
      transition: transform 0.8s ease-out;
    }

    .fly-inner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @media (max-width: 480px) {
      .header-wrap {
        padding: 0 10px;
        width: 100%;
        justify-content: center;
      }

      .logo {
        height: 20px;
      }

      .text {
        font-size: 5vw;
        margin: 0 30px;
      }

      .switcher {
        transform: translateY(-50%) scale(0.4) !important;
        right: -5px !important;
        top: 50%;
        width: 154px;
      }

      .container {
        padding-right: 12px;
      }

      #fav-sidebar {
        width: 100%;
        right: -100%;
      }

      #fav-trigger {
        top: auto;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        padding: 0;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        min-width: 0;
      }

      #cat-trigger {
        top: auto;
        bottom: 90px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        padding: 0;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        min-width: 0;
      }

      #fav-trigger .label-text,
      #cat-trigger .label-text {
        display: none;
      }

      .mobile-star {
        display: block;
        fill: #fff;
        width: 24px;
        height: 24px;
      }

      #fav-count {
        position: absolute;
        top: -2px;
        right: -2px;
        border: 2px solid var(--accent);
        width: 20px;
        height: 20px;
        font-size: 11px;
      }

      .toggle {
        width: 100%;
      }

      .search-row input.search {
        min-width: 100%;
      }

      .card {
        width: 100%;
      }

      .controls-row {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
      }

      .field.menu {
        min-width: 100%;
        max-width: 100%;
      }

      #slider-wrapper {
        width: 100%;
        max-width: 100%;
        margin-top: 15px;
        flex: 1;
      }

      /* Amazon grid mobile */
      .amz-card {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>

  <header class="site-header">
    <a href="https://www.trinexus.hu" target="_blank" class="logo-link" aria-label="Trinexus főoldal">
      <img src="logo2.png" alt="Trinexus Aqua" class="logo">
    </a>
    <div class="header-wrap">
      <div class="text">
        <span class="brand-main">Trinexus Aqua</span>
        <span class="brand-sub">termékkereső</span>
      </div>
      <form class="switcher">
        <fieldset class="switcher__legend">Theme Switcher</fieldset>
        <label class="switcher__option">
          <input type="radio" class="switcher__input" name="theme" value="light" c-option="1" checked>
          <div class="switcher__icon">
            <svg viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="12"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </div>
        </label>
        <label class="switcher__option">
          <input type="radio" class="switcher__input" name="theme" value="dark" c-option="2">
          <div class="switcher__icon">
            <svg viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </div>
        </label>
        <span class="switcher__filter"></span>
      </form>
    </div>
  </header>

  <div id="fav-trigger" onclick="toggleSidebar()">
    <span class="label-text">Kedvencek</span>
    <svg class="mobile-star" viewBox="0 0 24 24">
      <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
    </svg>
    <div id="fav-count">0</div>
  </div>

  <div id="cat-trigger" onclick="window.location.href='kepes_kereso_site.html'">
    <span class="label-text">Kategóriakereső</span>
    <svg class="mobile-star" viewBox="0 0 24 24">
      <path d="M10 3H3v7h7V3zm11 0h-7v7h7V3zm0 11h-7v7h7v-7zm-11 0H3v7h7v-7z" />
    </svg>
  </div>

  <aside id="fav-sidebar">
    <button class="close-sidebar-abs" onclick="toggleSidebar()">&times;</button>
    <div class="sidebar-tabs">
      <div class="sidebar-tab active" onclick="switchTab('fav')">Kedvencek</div>
      <div class="sidebar-tab" onclick="switchTab('history')">Előzmények</div>
    </div>
    <div class="sidebar-content-wrapper">
      <div id="fav-pane" class="sidebar-pane active">
        <div style="font-size:16px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
          <span style="color:#FFD700;">★</span> Kedvenc termékek
        </div>
        <div id="fav-list"></div>
        <div class="sidebar-footer" style="background:none; border:none; padding:0; margin-top:20px;">
          <button class="sidebar-btn" onclick="openAllFavorites()">Összes megnyitása</button>
          <button class="sidebar-btn clear-btn" onclick="clearFavorites()">Lista törlése</button>
        </div>
      </div>
      <div id="history-pane" class="sidebar-pane">
        <div class="history-section-title">Legutóbbi keresések</div>
        <div id="history-queries"></div>
        <div class="history-section-title" style="margin-top:25px;">Legutóbb megtekintett</div>
        <div id="history-products"></div>
        <div style="margin-top:20px; text-align:center;">
          <button class="clear-btn" style="border:none;" onclick="clearHistory()">Előzmények törlése</button>
        </div>
      </div>
    </div>
  </aside>

  <div class="container">

    <div class="search-row">
      <input id="q" class="search" type="search" placeholder="Írja be a termék nevét vagy cikkszámát..."
        autocomplete="off" disabled />
    </div>

    <div class="controls-row">
      <div id="slider-wrapper">
        <span id="price-min" class="price-label">0 Ft</span>
        <div id="slider"></div>
        <span id="price-max" class="price-label">0 Ft</span>
      </div>

      <div class="field menu" id="category-menu-container">
        <div class="control">
          <button id="category-toggle" aria-haspopup="true" aria-expanded="false">Kategória: Összes</button>
          <menu id="category-menu" role="listbox">
          </menu>
        </div>
      </div>

      <div class="field menu" id="sort-menu-container">
        <div class="control">
          <button id="sharing-toggle" aria-haspopup="true" aria-expanded="false">Rendezés: Relevancia</button>
          <menu id="sharing-menu" role="listbox">
            <li data-option="relevance" role="option" tabindex="0" class="selected">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <polygon
                  points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                </polygon>
              </svg>
              <h3>Relevancia</h3>
            </li>
            <li data-option="price_asc" role="option" tabindex="0">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="12" y1="19" x2="12" y2="5"></line>
                <polyline points="5 12 12 5 19 12"></polyline>
              </svg>
              <h3>Ár: növekvő</h3>
            </li>
            <li data-option="price_desc" role="option" tabindex="0">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <polyline points="19 12 12 19 5 12"></polyline>
              </svg>
              <h3>Ár: csökkenő</h3>
            </li>
            <li data-option="name_asc" role="option" tabindex="0">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M15 10l5 5 5-5" />
                <path d="M4 6h16" />
              </svg>
              <h3>Név A→Z</h3>
            </li>
            <li data-option="name_desc" role="option" tabindex="0">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M15 14l5-5 5 5" />
                <path d="M4 18h16" />
              </svg>
              <h3>Név Z→A</h3>
            </li>
          </menu>
        </div>
        <select id="sortSelect" hidden>
          <option value="relevance" selected>Relevancia</option>
          <option value="price_asc">Ár: növekvő</option>
          <option value="price_desc">Ár: csökkenő</option>
          <option value="name_asc">Név A→Z</option>
          <option value="name_desc">Név Z→A</option>
        </select>
      </div>

      <label style="white-space:nowrap; display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="imgOnly"> csak képpel
      </label>
    </div>

    <div class="amz-grid-container">
      <div class="amz-card">
        <div class="amz-header">Ajándékötletek</div>
        <div class="amz-grid-inner">
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Ajandekutalvany" target="_blank">
              <img src="https://mrgbeats.com/wp-content/uploads/2020/12/New-Project-1.png" alt="Kikötés">
            </a>
            <span>Ajándékutalvány</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/ajandektargy-butor-disztargy" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/RDH-0826/286x286,r/RDH-0826.webp?time=1733234164" alt="Horgony">
            </a>
            <span>Dísztárgyak</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/ajandektargy-hajosmodell" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/R124108/R124108.webp" alt="Kötél">
            </a>
            <span>Hajómakettek</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Etkeszlet-tanyer-pohar" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/4857/543x543,r/4857.webp?time=1689970093" alt="Fender">
            </a>
            <span>Étkészletek</span>
          </div>
        </div>
        <a href="https://www.trinexus.hu/ajandektargy" class="amz-footer" target="_blank">További ajándéktárgyak</a>
      </div>
    
      <div class="amz-card">
        <div class="amz-header">Csónakok</div>
        <div class="amz-grid-inner">
          <div class="amz-item">
            <a href="https://aquamarine-cactus-d0f609.netlify.app/?q=gumicsonak&minprice=299900&maxprice=499900"
              target="_blank">
              <img src="https://www.trinexus.hu/img/17496/842270/515x515,r/842270.webp?time=1681499434" alt="Fánk">
            </a>
            <span>Gumicsónakok 500.000,- alatt</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Caytan-aluminium-csonakok" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/A420B/572x572,r/A420B.webp?time=1719663001" alt="Mellény">
            </a>
            <span>Caytan alu csónakok</span>
          </div>
          <div class="amz-item">
            <a href="https://aquamarine-cactus-d0f609.netlify.app/?q=latrex&minprice=400000&maxprice=1000000"
              target="_blank">
              <img src="https://www.trinexus.hu/img/17496/000700/572x572,r/000700.webp?time=1682356094" alt="Wakeboard">
            </a>
            <span>Latrex csónakok 1.000.000,- alatt</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/csonak-cadrava-aluminium-csonakok" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/099100_altpic_1/099100.webp?time=1742934441" alt="SUP">
            </a>
            <span>Cadrava alu csónakok</span>
          </div>
        </div>
        <a href="https://www.trinexus.hu/Vizi_sport" class="amz-footer" target="_blank">Összes csónak</a>
      </div>
    
      <div class="amz-card">
        <div class="amz-header">Jó vételek</div>
        <div class="amz-grid-inner">
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Haswing-Osapian-55" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/50703_altpic_1/500x500/50703.webp?time=1739191463" alt="Radar">
            </a>
            <span>Osapian 55</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Deeper-Chirp-2-Trophy-Bundle" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/013548/486x486,r/013548.webp?time=1735904162" alt="GPS">
            </a>
            <span>Deeper CHIRP+2 okos szonár</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Garmin-Striker-Plus-9sv-Worldwide-w-GT52" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/GG010-02554-01/500x500/GG010-02554-01.webp?time=1743516669"
                alt="Audio">
            </a>
            <span>Garmin Striker Vivid 9 SV</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Humminbird-Xplore-9-CMSI" target="_blank">
              <img src="https://centrumzoo.hu/img/7097/596884/500x500/596884.webp?time=1732292994" alt="Műszer">
            </a>
            <span>Humminbird Xplore 9</span>
          </div>
        </div>
        <a href="https://www.trinexus.hu/akcios-termekek" class="amz-footer" target="_blank">További akciós termékek</a>
      </div>
    
      <div class="amz-card">
        <div class="amz-header">Haswing motorok</div>
        <div class="amz-grid-inner">
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Haswing-Osapian-30" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/50701-80E/500x500/50701-80E.webp?time=1748619926" alt="Festék">
            </a>
            <span>Osapian 30</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Haswing-Cayman-B55-Helmsman-GPS-12V-Gen-1-6" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/50736-137-W/1000x1000/50736-137-W.webp?time=1756236799"
                alt="Tisztító">
            </a>
            <span>Haswing Cayman B55 Helmsman GPS</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/Haswing-Protruar-1-0-65-lbs" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/50744/50744.webp?time=1756236391" alt="Olaj">
            </a>
            <span>Protruar 1.0</span>
          </div>
          <div class="amz-item">
            <a href="https://www.trinexus.hu/spd/50719-100/Haswing-Protruar-5-0-160-lbs-24V" target="_blank">
              <img src="https://www.trinexus.hu/img/17496/50719-100_altpic_2/50719-100.webp?time=1715699581"
                alt="Alkatrész">
            </a>
            <span>Protruar 5.0</span>
          </div>
        </div>
        <a href="https://www.trinexus.hu/elektromos-csonakmotor-haswing" class="amz-footer" target="_blank">További Haswing
          motorok</a>
      </div>
    </div>

    <div id="results-count" class="results-meta" style="display:none;"></div>
    <div id="results" class="results">
      <div class="loading"></div>
    </div>
    <div id="debug" class="debug" style="display:none"></div>
  </div>

  <footer style="font-size:13px;color:#666;padding:16px;text-align:center">© 2025 MageSoft. Minden jog fenntartva.
  </footer>

  <script type="module">
    import RangeSlider from "https://esm.sh/svelte-range-slider-pips";
    window.RangeSlider = RangeSlider; 
  </script>

  <script>
    /* ---------- GLOBALS & STATE ---------- */
    const MIN_TOKEN_LEN = 3;
    let favorites = [];
    let searchHistory = [];
    let viewHistory = [];
    let productsPool = [];
    let priceRange = { min: 0, max: 100000, currentMin: 0, currentMax: 0 };
    let sliderInstance = null;
    let currentState = { query: '', page: 1, isLoading: false, hasMore: true, categoryFilter: null };
    // ÚJ: Jelezzük, hogy ez az első betöltés-e (URL kezeléshez)
    let isFirstLoad = true;

    /* ---------- SEGÉDFÜGGVÉNY: URL OLVASÁS IFRAME-BEN IS ---------- */
    function getUrlParams() {
      let params = new URLSearchParams(window.location.search);
      try {
        if (window.parent !== window) {
          const parentParams = new URLSearchParams(window.parent.location.search);
          if (parentParams.has('q') || parentParams.has('minprice') || parentParams.has('maxprice')) {
            params = parentParams;
          }
        }
      } catch (e) { }
      return params;
    }

    /* ---------- ÚJ: BÖNGÉSZŐ ELŐZMÉNYEK FRISSÍTÉSE (HISTORY API) ---------- */
    function updateBrowserHistory(query, min, max) {
      // Ha nincs keresőszó, nem teszünk be semmit az URL-be
      if (!query) return;

      const url = new URL(window.location);
      url.searchParams.set('q', query);

      if (min > 0) url.searchParams.set('minprice', min);
      else url.searchParams.delete('minprice');

      if (max > 0) url.searchParams.set('maxprice', max);
      else url.searchParams.delete('maxprice');

      // Ez a parancs frissíti a címsort anélkül, hogy újratöltené az oldalt
      // Így a "Vissza" gomb is működni fog!
      window.history.pushState({ q: query, min: min, max: max }, '', url);
    }

    /* ---------- VISSZA GOMB KEZELÉSE ---------- */
    window.addEventListener('popstate', (event) => {
      // Ha a felhasználó megnyomja a Vissza gombot, olvassuk ki az URL-t
      const params = getUrlParams();
      const q = params.get('q');

      if (q) {
        document.getElementById('q').value = q;
        // Jelezzük a renderForQuery-nek, hogy ez történeti visszalépés (ne írja felül a history-t újra)
        renderForQuery(q, true, true);
      } else {
        // Ha nincs query, lehet, hogy a főoldalra léptünk vissza -> reset
        location.reload();
      }
    });

    /* ---------- SEGÉDFÜGGVÉNY: KATEGÓRIA TISZTÍTÁS ---------- */
    function getLeafCategory(rawCategory) {
      if (!rawCategory) return "Egyéb";
      if (Array.isArray(rawCategory)) {
        if (rawCategory.length === 0) return "Egyéb";
        return rawCategory[rawCategory.length - 1];
      }
      if (typeof rawCategory === 'string') {
        const parts = rawCategory.split('|');
        const cleanParts = parts.filter(p => p && p.trim().length > 0);
        if (cleanParts.length === 0) return "Egyéb";
        return cleanParts[cleanParts.length - 1].trim();
      }
      return "Egyéb";
    }

    /* ---------- SWITCHER ---------- */
    const switcher = document.querySelector('.switcher');
    if (switcher) {
      const radios = switcher.querySelectorAll('input[type="radio"]');
      const savedTheme = localStorage.getItem('theme_preference');
      if (savedTheme) {
        const rad = switcher.querySelector(`input[value="${savedTheme}"]`);
        if (rad) rad.checked = true;
      }
      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          if (radio.checked) localStorage.setItem('theme_preference', radio.value);
        });
      });
    }

    /* ---------- DATA HANDLING ---------- */
    try {
      const favStored = localStorage.getItem('trinexus_favorites');
      if (favStored) favorites = JSON.parse(favStored);
      const qStored = localStorage.getItem('trinexus_search_history');
      if (qStored) searchHistory = JSON.parse(qStored);
      const vStored = localStorage.getItem('trinexus_view_history');
      if (vStored) viewHistory = JSON.parse(vStored);
      document.addEventListener('DOMContentLoaded', updateSidebarUI);
    } catch (e) { console.error('LS Error', e); }

    function saveFavorites() { localStorage.setItem('trinexus_favorites', JSON.stringify(favorites)); }
    function saveHistory() {
      localStorage.setItem('trinexus_search_history', JSON.stringify(searchHistory));
      localStorage.setItem('trinexus_view_history', JSON.stringify(viewHistory));
    }
    function addToSearchHistory(q) {
      if (!q) return; q = q.trim();
      searchHistory = searchHistory.filter(item => item !== q);
      searchHistory.unshift(q); if (searchHistory.length > 5) searchHistory.pop();
      saveHistory(); updateHistoryUI();
    }
    function addToViewHistory(product) {
      viewHistory = viewHistory.filter(item => item.sku !== product.sku);
      viewHistory.unshift(product); if (viewHistory.length > 10) viewHistory.pop();
      saveHistory(); updateHistoryUI();
    }

    /* ---------- UI ACTIONS ---------- */
    function toggleSidebar() { document.getElementById('fav-sidebar').classList.toggle('open'); document.body.classList.toggle('sidebar-open'); }
    window.switchTab = function (tabName) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sidebar-pane').forEach(p => p.classList.remove('active'));
      if (tabName === 'fav') {
        document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
        document.getElementById('fav-pane').classList.add('active');
      } else {
        document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
        document.getElementById('history-pane').classList.add('active');
        updateHistoryUI();
      }
    };
    document.addEventListener('click', function (e) {
      const sb = document.getElementById('fav-sidebar'); const trig = document.getElementById('fav-trigger');
      if (sb.classList.contains('open') && !sb.contains(e.target) && !trig.contains(e.target)) toggleSidebar();
    });

    function isFavorite(sku) { return favorites.some(f => f.sku === sku); }
    function toggleFavorite(product, btnElement, imgElement) {
      const idx = favorites.findIndex(f => f.sku === product.sku);
      if (idx > -1) {
        favorites.splice(idx, 1); btnElement.classList.remove('active'); btnElement.innerHTML = getStarIcon(false);
      } else {
        favorites.push(product); btnElement.classList.add('active'); btnElement.innerHTML = getStarIcon(true);
        if (imgElement) runFlyAnimation(imgElement);
      }
      saveFavorites(); updateSidebarUI();
    }
    function getStarIcon(isActive) { return `<svg viewBox="0 0 24 24"><path fill="${isActive ? '#FFD700' : 'currentColor'}" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`; }

    function updateSidebarUI() {
      const listEl = document.getElementById('fav-list'); const countEl = document.getElementById('fav-count');
      if (listEl && countEl) {
        countEl.textContent = favorites.length; countEl.style.display = favorites.length > 0 ? 'flex' : 'none';
        if (favorites.length === 0) listEl.innerHTML = '<div style="text-align:center; color: var(--muted); margin-top:40px; font-size:13px;">Még nincs kedvenc terméked.<br>Kattints a <span style="color:#ccc; font-size:16px;">★</span> ikonra!</div>';
        else { listEl.innerHTML = ''; favorites.forEach(p => listEl.appendChild(createSideItem(p, true))); }
      }
      updateHistoryUI();
    }
    function updateHistoryUI() {
      const qEl = document.getElementById('history-queries');
      if (qEl) {
        if (searchHistory.length === 0) qEl.innerHTML = '<div style="font-size:13px; color:var(--muted); font-style:italic;">Nincs előzmény</div>';
        else {
          qEl.innerHTML = '';
          searchHistory.forEach(q => {
            const tag = document.createElement('span'); tag.className = 'history-tag'; tag.textContent = q;
            tag.onclick = () => { document.getElementById('q').value = q; renderForQuery(q, true); toggleSidebar(); };
            qEl.appendChild(tag);
          });
        }
      }
      const vEl = document.getElementById('history-products');
      if (vEl) {
        if (viewHistory.length === 0) vEl.innerHTML = '<div style="font-size:13px; color:var(--muted); font-style:italic;">Nincs megtekintett termék</div>';
        else { vEl.innerHTML = ''; viewHistory.forEach(p => vEl.appendChild(createSideItem(p, false))); }
      }
    }
    function createSideItem(p, isFavList) {
      const item = document.createElement('div'); item.className = 'fav-item';
      let imgSrc = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
      if (p.img) { const imgs = p.img.toString().split(/\||,|;|\n/).filter(Boolean); if (imgs.length) imgSrc = imgs[0].startsWith('http') ? imgs[0] : 'https://' + imgs[0]; }
      let html = `<a href="${p.url}" target="_blank" onclick="addToViewHistory({sku:'${p.sku}',name:'${p.name.replace(/'/g, "\\'")}',price:'${p.price}',img:'${p.img}',url:'${p.url}'})"><img src="${imgSrc}" alt=""></a><div class="fav-info"><div class="fav-name">${p.name}</div><div class="fav-price">${p.price ? Math.round(p.price).toLocaleString('hu-HU') + ' Ft' : ''}</div></div>`;
      if (isFavList) html += `<div class="remove-fav" onclick="removeFavBySku('${p.sku}')">×</div>`;
      item.innerHTML = html; return item;
    }
    window.clearFavorites = function () { if (confirm('Biztosan törölni szeretnéd a kedvenceket?')) { favorites = []; saveFavorites(); updateSidebarUI(); document.querySelectorAll('.card .fav-icon').forEach(b => { b.classList.remove('active'); b.innerHTML = getStarIcon(false) }); } };
    window.removeFavBySku = function (sku) { const idx = favorites.findIndex(f => f.sku === sku); if (idx > -1) { favorites.splice(idx, 1); saveFavorites(); updateSidebarUI(); } };
    window.openAllFavorites = function () { if (favorites.length && confirm(favorites.length + " termék megnyitása?")) [...favorites].reverse().forEach((p, i) => { if (p.url) setTimeout(() => window.open(p.url, '_blank'), i * 300); }); };
    window.clearHistory = function () { if (confirm('Törlöd az előzményeket?')) { searchHistory = []; viewHistory = []; saveHistory(); updateHistoryUI(); } };

    function runFlyAnimation(sourceImg) {
      const triggerBtn = document.getElementById('fav-trigger'); if (!triggerBtn) return;
      const targetRect = triggerBtn.getBoundingClientRect(); const startRect = sourceImg.getBoundingClientRect();
      const flyContainer = document.createElement('div'); flyContainer.className = 'fly-container';
      const flyInner = document.createElement('div'); flyInner.className = 'fly-inner';
      flyInner.appendChild(sourceImg.cloneNode()); flyContainer.appendChild(flyInner); document.body.appendChild(flyContainer);
      flyContainer.style.transform = `translate(${startRect.left}px, ${startRect.top}px)`;
      flyContainer.style.width = startRect.width + 'px'; flyContainer.style.height = startRect.height + 'px';
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const destX = targetRect.left + (targetRect.width / 2) - 25; const destY = targetRect.top + (targetRect.height / 2) - 25;
          flyContainer.style.transform = `translate(${destX}px, ${startRect.top}px)`;
          flyContainer.style.width = '20px'; flyContainer.style.height = '20px'; flyContainer.style.opacity = '0.5';
          flyInner.style.transform = `translateY(${destY - startRect.top}px)`;
        });
      });
      setTimeout(() => { flyContainer.remove(); triggerBtn.style.transform = 'scale(1.2)'; setTimeout(() => triggerBtn.style.transform = 'scale(1)', 200); }, 800);
    }


    /* ---------- KATEGÓRIA DROPDOWN LOGIKA ---------- */
    function updateCategoryDropdown(products) {
      const menuList = document.getElementById('category-menu');
      const btn = document.getElementById('category-toggle');

      if (!menuList || !btn) return;

      menuList.innerHTML = '';
      const categories = {};

      if (products && products.length > 0) {
        products.forEach(p => {
          const leaf = getLeafCategory(p.category);
          if (leaf && leaf !== "Egyéb") {
            categories[leaf] = (categories[leaf] || 0) + 1;
          }
        });
      }

      const allLi = document.createElement('li');
      allLi.innerHTML = `<h3>Összes termék</h3>`;
      if (currentState.categoryFilter === null) {
        allLi.className = 'selected';
      }
      allLi.addEventListener('click', (e) => {
        e.stopPropagation();
        currentState.categoryFilter = null;
        btn.textContent = "Kategória: Összes";
        closeAllMenus();
        filterAndRender();
      });
      menuList.appendChild(allLi);

      const keys = Object.keys(categories);
      keys.sort().forEach(catName => {
        const li = document.createElement('li');
        li.innerHTML = `<h3>${catName} <small style="opacity:0.6">(${categories[catName]})</small></h3>`;

        if (currentState.categoryFilter === catName) {
          li.classList.add('selected');
        }

        li.addEventListener('click', (e) => {
          e.stopPropagation();
          currentState.categoryFilter = catName;
          btn.textContent = `Kategória: ${catName}`;
          closeAllMenus();
          filterAndRender();
        });
        menuList.appendChild(li);
      });
    }

    function closeAllMenus() {
      document.querySelectorAll('.field.menu').forEach(field => {
        field.classList.remove('open');
        const btn = field.querySelector('button');
        if (btn) btn.setAttribute('aria-expanded', false);
      });
    }

    /* ---------- ACTION MENU LOGIC ---------- */
    (function initMenus() {
      const fields = document.querySelectorAll('.field.menu');

      fields.forEach(field => {
        const btn = field.querySelector('button');
        const menu = field.querySelector('menu');
        const options = menu.querySelectorAll('li');
        const select = field.querySelector('select');

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = field.classList.contains('open');
          closeAllMenus();
          if (!isOpen) {
            field.classList.add('open');
            btn.setAttribute('aria-expanded', true);
          }
        });

        if (select) {
          if (menu) {
            const items = menu.querySelectorAll('li');
            items.forEach(opt => {
              opt.addEventListener('click', (e) => {
                e.stopPropagation();
                const val = opt.dataset.option;
                select.value = val;
                items.forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                closeAllMenus();
                filterAndRender();
              });
            });
          }
        }
      });

      document.body.addEventListener('click', () => closeAllMenus());
    })();

    /* ---------- SLIDER ---------- */
    function initSlider() {
      if (!window.RangeSlider) { setTimeout(initSlider, 100); return; }
      sliderInstance = new window.RangeSlider({
        target: document.getElementById('slider'), props: { values: [0, 100000], min: 0, max: 100000, range: true, pips: false, springValues: { stiffness: 0.15, damping: 0.4 } }
      });
      sliderInstance.$on('change', ({ detail }) => {
        const [min, max] = detail.values; priceRange.currentMin = min; priceRange.currentMax = max;
        updatePriceLabels(min, max, priceRange.min, priceRange.max); filterAndRender();
      });
    }
    function updatePriceLabels(vMin, vMax, absMin, absMax) {
      const lblMin = document.getElementById('price-min'); const lblMax = document.getElementById('price-max'); const sliderEl = document.querySelector('#slider .rangeSlider'); if (!sliderEl) return;
      const totalRange = absMax - absMin; if (totalRange <= 0) return;
      lblMin.textContent = Math.round(vMin).toLocaleString('hu-HU') + ' Ft'; lblMax.textContent = Math.round(vMax).toLocaleString('hu-HU') + ' Ft';
      requestAnimationFrame(() => {
        let length = parseFloat(sliderEl.style.getPropertyValue('--slider-length') || 0);
        const minPosPct = ((vMin - absMin) / totalRange) * 100; const maxPosPct = ((vMax - absMin) / totalRange) * 100;
        lblMin.style.setProperty('--pos', minPosPct); lblMin.style.setProperty('--slider-length', length);
        lblMax.style.setProperty('--pos', maxPosPct); lblMax.style.setProperty('--slider-length', length);
        const diff = maxPosPct - minPosPct;
        if (diff < 15) { lblMin.style.transform = 'translateX(-100%)'; lblMax.style.transform = 'translateX(0%)'; }
        else { lblMin.style.transform = 'translateX(-50%)'; lblMax.style.transform = 'translateX(-50%)'; }
      });
    }

    /* ---------- JAVÍTOTT SLIDER LOGIKA (BERAGADÁS ELLEN) ---------- */
    function updateSliderBounds(products) {
      if (!products || products.length === 0) return;
      
      // 1. Megkeressük a tényleges legolcsóbb és legdrágább terméket a találatokban
      const prices = products.map(p => parseFloat(p.price)).filter(p => !isNaN(p));
      if (prices.length === 0) return;
      
      const absMin = Math.floor(Math.min(...prices)); 
      const absMax = Math.ceil(Math.max(...prices));
      
      // Beállítjuk a csúszka technikai határait
      priceRange.min = absMin; 
      priceRange.max = absMax;

      if (sliderInstance) { 
          sliderInstance.$set({ min: absMin, max: absMax });

          let nextMin = priceRange.currentMin;
          let nextMax = priceRange.currentMax;

          if (isFirstLoad) {
              // CSAK első betöltéskor nézzük az URL-t
              const urlParams = getUrlParams();
              const urlMin = urlParams.get('minprice');
              const urlMax = urlParams.get('maxprice');

              if (urlMin) nextMin = Number(urlMin);
              else if (nextMin < absMin) nextMin = absMin; 

              if (urlMax) nextMax = Number(urlMax);
              else if (nextMax === 0 || (!urlMax && nextMax < absMax)) {
                  nextMax = absMax;
              }
          } else {
             // Kézi keresésnél: Ha a határok nullák (reset volt), vagy érvénytelenek,
             // akkor nyissuk ki a csúszkát teljesen a találatokra.
             if (nextMax === 0 || (nextMin === 0 && nextMax === 0)) {
                 nextMin = absMin;
                 nextMax = absMax;
             }
          }

          // Biztonsági korrekció (ne lógjon ki a csúszka)
          if (nextMin < absMin) nextMin = absMin;
          if (nextMax > absMax) nextMax = absMax;

          // Értékek mentése és csúszka frissítése
          priceRange.currentMin = nextMin;
          priceRange.currentMax = nextMax;
          
          sliderInstance.$set({ values: [nextMin, nextMax] });
          updatePriceLabels(nextMin, nextMax, absMin, absMax); 
      }
      
      // Innentől kezdve már biztosan nem első betöltés
      isFirstLoad = false;
    }

    /* ---------- API & RENDER ---------- */
    async function fetchProducts(query, page, limit) {
      const params = new URLSearchParams({ q: query, page: page, limit: limit });
      const response = await fetch(`${window.API_BASE}?${params.toString()}`);
      if (!response.ok) throw new Error('Hálózati hiba');
      return await response.json();
    }

    function filterAndRender() {
      const filtered = productsPool.filter(p => {
        const price = parseFloat(p.price); if (isNaN(price)) return false;
        if (price < priceRange.currentMin || (priceRange.currentMax > 0 && price > priceRange.currentMax)) return false;

        if (currentState.categoryFilter) {
          const leaf = getLeafCategory(p.category);
          if (leaf !== currentState.categoryFilter) return false;
        }

        return true;
      });
      const countEl = document.getElementById('results-count');
      if (countEl) { countEl.style.display = 'block'; countEl.textContent = `Találatok: ${filtered.length} db`; }
      renderProductsList(filtered);
    }

    function renderProductsList(list) {
      const resultsEl = document.getElementById('results'); resultsEl.innerHTML = '';
      const imgOnly = document.getElementById('imgOnly') && document.getElementById('imgOnly').checked;
      let finalList = list;
      if (imgOnly) finalList = list.filter(p => p.img && p.img.length > 0);
      if (finalList.length === 0) { resultsEl.innerHTML = '<div class="no-results">Nincs találat.</div>'; return; }

      const sortVal = document.getElementById('sortSelect').value;
      if (sortVal !== 'relevance') {
        finalList.sort((a, b) => {
          if (sortVal.includes('price')) { const na = Number(a.price) || 0; const nb = Number(b.price) || 0; return sortVal === 'price_asc' ? na - nb : nb - na; }
          if (sortVal.includes('name')) { const na = (a.name || '').toLowerCase(); const nb = (b.name || '').toLowerCase(); return sortVal === 'name_asc' ? na.localeCompare(nb) : nb.localeCompare(na); }
          if (sortVal === 'name_desc') return (b.name || '').toLowerCase().localeCompare((a.name || '').toLowerCase());
          return 0;
        });
      }

      let row = document.createElement('div'); row.className = 'row';

      finalList.forEach(p => {
        const card = document.createElement('a'); card.className = 'card'; card.href = p.url || '#'; card.target = '_blank'; card.setAttribute('data-glow', '');
        card.onclick = function () { addToViewHistory(p); };
        const bgLayer = document.createElement('div'); bgLayer.className = 'card-bg'; card.appendChild(bgLayer);

        const overlay = document.createElement('div'); overlay.className = 'overlay';
        const img = document.createElement('img'); img.loading = 'lazy';
        const imgs = (p.img || '').toString().split(/\||,|;|\n/).filter(Boolean);
        img.src = imgs.length ? (imgs[0].startsWith('http') ? imgs[0] : 'https://' + imgs[0]) : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
        overlay.appendChild(img);
        overlay.appendChild(Object.assign(document.createElement('div'), { className: 'name-bar', textContent: p.name || '-' }));

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.innerHTML = `<span class="sku">${p.sku || ''}</span><span class="price">${p.price ? Math.round(p.price).toLocaleString('hu-HU') + ' Ft' : ''}</span>`;
        card.appendChild(overlay); card.appendChild(meta);

        // CSILLAG
        const favBtn = document.createElement('div'); favBtn.className = 'fav-icon';
        const isFav = isFavorite(p.sku); if (isFav) favBtn.classList.add('active');
        favBtn.innerHTML = getStarIcon(isFav);
        favBtn.onclick = function (e) { e.preventDefault(); e.stopPropagation(); toggleFavorite(p, this, card.querySelector('img')); };
        card.appendChild(favBtn);

        row.appendChild(card);
      });
      resultsEl.appendChild(row);

      if (currentState.hasMore) createLoadMoreButton(); else removeLoadMoreButton();
      if (window.attachCardPointer) window.attachCardPointer();
    }

    async function renderForQuery(q, isManualSearch = false, isHistoryNav = false) {
      const resultsEl = document.getElementById('results'); const countEl = document.getElementById('results-count');
      if (!q || q.trim().length < MIN_TOKEN_LEN) { resultsEl.innerHTML = '<div class="no-results">Írjon legalább ' + MIN_TOKEN_LEN + ' karaktert.</div>'; if (countEl) countEl.style.display = 'none'; removeLoadMoreButton(); return; }

      currentState.query = q.trim(); currentState.page = 1; productsPool = [];
      
      if (isManualSearch) {
          // ITT A JAVÍTÁS:
          priceRange.currentMin = 0;
          priceRange.currentMax = 0; 
          currentState.categoryFilter = null;
          document.getElementById('category-toggle').textContent = "Kategória: Összes";
          
          // Kényszerítjük, hogy ne vegye figyelembe a régi URL paramétereket
          isFirstLoad = false; 
          
          // Azonnal töröljük a "beragadt" paramétereket a böngésző címsorából
          updateBrowserHistory(currentState.query, 0, 0); 
      }

      resultsEl.innerHTML = '<div class="loading">Keresés...</div>'; if (countEl) countEl.style.display = 'none';

      try {
        const data = await fetchProducts(currentState.query, 1, 500);
        productsPool = data.results;

        updateCategoryDropdown(productsPool);

        if (data.results.length > 0) addToSearchHistory(currentState.query);
        if (data.total_count > 500) { currentState.hasMore = true; } else { currentState.hasMore = false; }
        if (productsPool.length === 0) { resultsEl.innerHTML = '<div class="no-results">Nincs találat.</div>'; return; }
        resultsEl.innerHTML = '';

        // JAVÍTÁS: Update Slider után frissítjük az URL-t is, ha nem a vissza gombot nyomtuk
        updateSliderBounds(productsPool);
        filterAndRender();

        if (isManualSearch && !isHistoryNav) {
          updateBrowserHistory(currentState.query, priceRange.currentMin, priceRange.currentMax);
        }

      } catch (err) { console.error(err); resultsEl.innerHTML = '<div class="no-results">Hiba történt: ' + err.message + '</div>'; }
    }

    async function loadMore() {
      if (currentState.isLoading || !currentState.hasMore) return;
      const btnContent = document.querySelector('.fancy-btn .btn-content'); if (btnContent) btnContent.textContent = 'Betöltés...';
      currentState.isLoading = true;
      try {
        currentState.page++;
        const data = await fetchProducts(currentState.query, currentState.page, 500);
        productsPool = [...productsPool, ...data.results];

        updateCategoryDropdown(productsPool);
        updateSliderBounds(productsPool);
        if (data.total_count <= productsPool.length) currentState.hasMore = false;
        filterAndRender();
      } catch (err) { console.error(err); if (btnContent) btnContent.textContent = 'Hiba (próbáld újra)'; } finally { currentState.isLoading = false; }
    }

    function createLoadMoreButton() {
      removeLoadMoreButton();
      const btnContainer = document.createElement('div'); btnContainer.id = 'loadMoreContainer'; btnContainer.className = 'fancy-btn-container';
      const btn = document.createElement('button'); btn.id = 'loadMoreBtn'; btn.className = 'fancy-btn'; btn.onclick = loadMore;
      const cellsDiv = document.createElement('div'); cellsDiv.className = 'btn-cells'; for (let i = 0; i < 20; i++) { cellsDiv.appendChild(document.createElement('span')); }
      const contentSpan = document.createElement('span'); contentSpan.className = 'btn-content'; contentSpan.textContent = 'További találatok';
      btn.appendChild(cellsDiv); btn.appendChild(contentSpan); btnContainer.appendChild(btn);
      document.getElementById('results').parentNode.insertBefore(btnContainer, document.getElementById('results').nextSibling);
    }
    function removeLoadMoreButton() { const el = document.getElementById('loadMoreContainer'); if (el) el.remove(); }

    function attachCardPointer() {
      const cards = Array.from(document.querySelectorAll('.card[data-glow]'));
      cards.forEach(card => {
        if (card._glowPointerAttached) return; card._glowPointerAttached = true;
        let onMove = (ev) => {
          const rect = card.getBoundingClientRect();
          const x = Math.max(0, Math.min(rect.width, ev.clientX - rect.left));
          const y = Math.max(0, Math.min(rect.height, ev.clientY - rect.top));
          card.style.setProperty('--x', x.toFixed(2)); card.style.setProperty('--xp', (x / rect.width).toFixed(3));
          card.style.setProperty('--y', y.toFixed(2)); card.style.setProperty('--yp', (y / rect.height).toFixed(3));
        };
        card.addEventListener('pointermove', onMove, { passive: true }); card.addEventListener('pointerenter', onMove);
      });
    }

    (function wireEvents() {
      var qInput = document.getElementById('q'); var timer = null;
      if (qInput) {
        qInput.addEventListener('input', function (e) {
          clearTimeout(timer); timer = setTimeout(function () { renderForQuery(e.target.value, true); }, 500);
        });
      }
      document.getElementById('sortSelect').addEventListener('change', filterAndRender);
      document.getElementById('imgOnly').addEventListener('change', filterAndRender);
      var qEl = document.getElementById('q'); if (qEl) qEl.disabled = false;
    })();

    document.addEventListener('DOMContentLoaded', function () {
      initSlider();

      const urlParams = getUrlParams();
      const queryParam = urlParams.get('q');
      const minPriceParam = urlParams.get('minprice');
      const maxPriceParam = urlParams.get('maxprice');

      if (queryParam) {
        const qInput = document.getElementById('q');
        qInput.value = queryParam;

        if (minPriceParam) priceRange.currentMin = Number(minPriceParam);
        if (maxPriceParam) priceRange.currentMax = Number(maxPriceParam);

        setTimeout(() => {
          if (sliderInstance && (minPriceParam || maxPriceParam)) {
            sliderInstance.$set({
              values: [priceRange.currentMin, priceRange.currentMax]
            });
          }
          // Első betöltéskor NOT manual search (false)
          renderForQuery(queryParam, false);
        }, 500);
      }

      var prodBtn = document.getElementById('prodBtn'); var catBtn = document.getElementById('catBtn');
      if (prodBtn) prodBtn.addEventListener('click', function (e) { e.preventDefault(); prodBtn.classList.add('active'); catBtn.classList.remove('active'); });
      if (catBtn) catBtn.addEventListener('click', function (e) { e.preventDefault(); window.location.href = 'kepes_kereso_site.html'; });
      updateSidebarUI();
    });
  </script>
</body>

</html>
